# Campaigns Plugin

<!-- Core plugin -- always enabled, cannot be disabled. -->

## Purpose

Manages campaigns (worldbuilding containers). A campaign is the top-level
organizational unit that holds all entities, maps, timelines, etc. Each user
can create multiple campaigns. Campaigns have role-based membership.

## Tier

Plugin (Core -- always enabled)

## Domain Concepts

- **Campaign:** A named worldbuilding project. Contains entities, has settings
  for which modules/plugins are enabled, and owns entity type configurations.
- **Campaign Member:** A user who has access to a campaign with a specific role.
- **Campaign Role:** Owner (3), Scribe (2), Player (1). Numeric levels for >= comparisons.
- **Ownership Transfer:** Token-based transfer flow. 72h expiry, optional email.
- **Dual Permission Model:** MemberRole for content visibility, IsSiteAdmin for admin actions.

## Files

| File | Purpose |
|------|---------|
| model.go | Campaign, CampaignMember, Role system, CampaignContext, OwnershipTransfer, UserFinder interface, MailService interface, DTOs, Slugify |
| repository.go | CampaignRepository interface + MariaDB impl (CRUD, membership, transfers, atomic ownership transfer) |
| user_finder.go | UserFinderAdapter wrapping auth.UserRepository |
| service.go | CampaignService (CRUD with slug gen, membership validation, ownership transfer, admin operations) |
| middleware.go | RequireCampaignAccess, RequireRole, GetCampaignContext |
| handler.go | 16 thin HTTP handlers for campaigns, members, settings, transfers |
| routes.go | Route registration with middleware chains |
| index.templ | Campaign list page (grid of cards) |
| campaign_card.templ | Single campaign card partial |
| form.templ | Create/edit campaign form (shared) |
| show.templ | Campaign dashboard with transfer banner |
| settings.templ | Settings: edit info, danger zone, pending transfer |
| members.templ | Member list + add form + role dropdowns |

## Dependencies

- **Uses:** auth (RequireAuth, GetSession, GetUserID, UserRepository via adapter), smtp (MailService for transfer emails)
- **Used by:** entities, maps, tags, admin, and all campaign-scoped plugins

## Routes

| Method | Path | Handler | Min Role | Description |
|--------|------|---------|----------|-------------|
| GET | /campaigns | Index | Auth only | List user's campaigns |
| GET | /campaigns/new | NewForm | Auth only | Create campaign form |
| POST | /campaigns | Create | Auth only | Create campaign |
| GET | /campaigns/:id | Show | Player | Campaign dashboard |
| GET | /campaigns/:id/edit | EditForm | Owner | Edit form |
| PUT | /campaigns/:id | Update | Owner | Update campaign |
| DELETE | /campaigns/:id | Delete | Owner | Delete campaign |
| GET | /campaigns/:id/settings | Settings | Owner | Campaign settings |
| GET | /campaigns/:id/members | Members | Player | Member list |
| POST | /campaigns/:id/members | AddMember | Owner | Add member by email |
| DELETE | /campaigns/:id/members/:uid | RemoveMember | Owner | Remove member |
| PUT | /campaigns/:id/members/:uid/role | UpdateRole | Owner | Change role |
| GET | /campaigns/:id/transfer | TransferForm | Owner | Transfer form |
| POST | /campaigns/:id/transfer | Transfer | Owner | Initiate transfer |
| GET | /campaigns/:id/accept-transfer | AcceptTransfer | Auth only | Accept (token) |
| POST | /campaigns/:id/cancel-transfer | CancelTransfer | Owner | Cancel transfer |

## Business Rules

- Campaign names must be non-empty (max 200 chars)
- Slug auto-generated from name, deduplicated with -2/-3 suffix
- Owner cannot remove self or change own role (must transfer first)
- Ownership transfer: DB transaction swaps roles atomically
- Old owner becomes Scribe after transfer
- Admin force-transfer: admin joining as Owner demotes current owner to Scribe
- Regular member addition cannot assign Owner role (use transfer instead)
- Deleting a campaign cascades to all members, transfers, etc. (FK CASCADE)
- Campaign settings JSON stores which modules/plugins are enabled

## Current State

- [x] .ai.md created
- [x] Migration written (000002)
- [x] Model + Role system implemented
- [x] Repository implemented (full CRUD + membership + transfers)
- [x] Service implemented (CRUD, slug gen, membership, transfer, admin ops)
- [x] Middleware implemented (RequireCampaignAccess, RequireRole)
- [x] Handler implemented (16 handlers)
- [x] Templates created (6 templ files)
- [x] Routes defined
- [x] Integrated with main router
- [ ] Tests written
