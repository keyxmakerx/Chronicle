# Calendar Plugin

Custom fantasy calendar system for campaigns. Supports arbitrary months, weekdays,
moons (with phase calculations), seasons (with wrap-around date ranges), leap years,
and events (single-day, multi-day, recurring). One calendar per campaign.

## Architecture

- **model.go**: Calendar, Month, Weekday, Moon, Season, Event structs + DTOs.
  `MoonPhase()` / `MoonPhaseName()` for lunar cycle math.
  `IsLeapYear()`, `YearLengthForYear()`, `MonthDays()` for date arithmetic.
  `ContainsDate()` on Season with wrap-around support.
- **repository.go**: SQL CRUD for calendar + sub-resources. Set* methods replace
  all records (bulk update). Event listing with entity JOIN, visibility filtering,
  recurring event support.
- **service.go**: One-calendar-per-campaign enforcement, validation, date advancement
  with month/year rollover (leap-year-aware), CRUD orchestration.
- **handler.go**: HTTP handlers for monthly grid, timeline, settings, events, setup.
  HTMX detection for fragment vs full page. Falls back to setup page if no calendar.
- **routes.go**: Route registration with role middleware.
- **calendar.templ**: Monthly grid, timeline view, event modal, upcoming events
  fragment, entity-events fragment, setup page.
- **calendar_settings.templ**: 5-tab settings page (General, Months, Weekdays,
  Moons, Seasons) with Alpine.js list management.

## Data Model

- `calendars` — id, campaign_id, name, description, epoch_name, current_year/month/day,
  leap_year_every, leap_year_offset
- `calendar_months` — id, calendar_id, name, days, sort_order, is_intercalary,
  leap_year_days
- `calendar_weekdays` — id, calendar_id, name, sort_order
- `calendar_moons` — id, calendar_id, name, cycle_days, phase_offset, color
- `calendar_seasons` — id, calendar_id, name, start_month/day, end_month/day,
  description, color
- `calendar_events` — id, calendar_id, entity_id (FK), name, description,
  year/month/day, end_year/end_month/end_day, is_recurring, recurrence_type,
  visibility, category, created_by

## Key Design Decisions

- **One calendar per campaign** (unlike maps' many-per-campaign). Enforced in
  service CreateCalendar().
- **Bulk sub-resource updates**: SetMonths/SetWeekdays/SetMoons/SetSeasons replace
  all records rather than individual CRUD — simpler client-side serialization.
- **Percentage-free date system**: Month days and leap year days are integers.
  Year length calculated by summing month days + per-month leap extras.
- **Moon phases**: Continuous 0.0–1.0 value from `cycle_days` and `phase_offset`.
  Mapped to 8 named phases (New, Waxing Crescent, etc.).
- **Season wrap-around**: `ContainsDate()` handles seasons crossing year boundary
  (e.g., Winter from month 11 to month 2).
- **Event categories**: holiday, battle, quest, birthday, festival, travel, custom.
  Each has an icon in the UI.
- **Dual views**: Monthly grid (default) and timeline (chronological, year-grouped).

## Routes

| Method | Path | Role | Handler |
|--------|------|------|---------|
| GET | /campaigns/:id/calendar | Player | Show |
| GET | /campaigns/:id/calendar/timeline | Player | ShowTimeline |
| GET | /campaigns/:id/calendar/entity-events/:eid | Player | EntityEventsFragment |
| GET | /campaigns/:id/calendar/upcoming | Player | UpcomingEventsFragment |
| POST | /campaigns/:id/calendar | Owner | CreateCalendar |
| DELETE | /campaigns/:id/calendar | Owner | DeleteCalendarAPI |
| GET | /campaigns/:id/calendar/settings | Owner | ShowSettings |
| PUT | /campaigns/:id/calendar/settings | Owner | UpdateCalendarAPI |
| PUT | /campaigns/:id/calendar/months | Owner | UpdateMonthsAPI |
| PUT | /campaigns/:id/calendar/weekdays | Owner | UpdateWeekdaysAPI |
| PUT | /campaigns/:id/calendar/moons | Owner | UpdateMoonsAPI |
| PUT | /campaigns/:id/calendar/seasons | Owner | UpdateSeasonsAPI |
| POST | /campaigns/:id/calendar/advance | Owner | AdvanceDateAPI |
| POST | /campaigns/:id/calendar/events | Scribe | CreateEventAPI |
| PUT | /campaigns/:id/calendar/events/:eid | Scribe | UpdateEventAPI |
| DELETE | /campaigns/:id/calendar/events/:eid | Owner | DeleteEventAPI |

## Sync API Integration

Calendar has full REST API endpoints exposed through the sync-api plugin for external
tools (Foundry VTT). See `internal/plugins/syncapi/` for those routes.

## Dashboard Integration

- `calendar_preview` block type for campaign dashboard editor
- `GET /calendar/upcoming?limit=N` serves HTMX fragment with current date, season,
  and upcoming events
- Entity-event reverse lookup: `GET /calendar/entity-events/:eid` serves events
  linked to a specific entity (lazy-loaded on entity profile pages)
