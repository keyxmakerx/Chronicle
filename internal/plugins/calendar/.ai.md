# Calendar Plugin

Two-mode calendar system for campaigns. **Fantasy mode**: arbitrary months, weekdays,
moons (with phase calculations), seasons (with wrap-around date ranges), leap years,
configurable time systems. **Real-life mode**: Gregorian calendar synced to wall clock,
user timezone-aware. Both modes support events (single-day, multi-day, recurring, with
optional start/end times). One calendar per campaign.

## Architecture

- **model.go**: Calendar, Month, Weekday, Moon, Season, Event structs + DTOs.
  `ModeFantasy`/`ModeRealLife` constants. `IsRealLife()` mode check.
  `MoonPhase()` / `MoonPhaseName()` for lunar cycle math.
  `IsLeapYear()`, `YearLengthForYear()`, `MonthDays()` for date arithmetic.
  `ContainsDate()` on Season with wrap-around support.
  `FormatCurrentTime()` on Calendar for HH:MM display.
  `HasTime()`, `FormatTime()`, `FormatEndTime()`, `FormatTimeRange()` on Event.
  `HasRichText()`, `PlainDescription()` on Event for rich text support.
- **repository.go**: SQL CRUD for calendar + sub-resources. Set* methods replace
  all records (bulk update). Event listing with entity JOIN, visibility filtering,
  recurring event support. Events sort by date then time (COALESCE for null times).
- **service.go**: One-calendar-per-campaign enforcement, validation, date advancement
  with month/year rollover (leap-year-aware), time advancement with minute→hour→day
  rollover, CRUD orchestration.
- **handler.go**: HTTP handlers for monthly grid, timeline, settings, events, setup,
  advance date/time, import/export. HTMX detection for fragment vs full page. Mode-aware
  CreateCalendar seeds Gregorian months/weekdays for real-life mode.
- **routes.go**: Route registration with role middleware.
- **export.go**: Chronicle native JSON export format (`chronicle-calendar-v1`).
  `ChronicleExport` envelope with calendar config + optional events. `BuildExport()`
  creates export from a fully-loaded Calendar + events.
- **import.go**: Auto-detection and parsing of 4 calendar JSON formats:
  Chronicle native, Simple Calendar (Foundry VTT v1+v2), Calendaria (Foundry VTT),
  and Fantasy-Calendar.com. `DetectAndParse()` inspects top-level JSON keys to
  identify format, then delegates to format-specific parsers. Handles 0-indexed vs
  1-indexed conversion, localization key stripping, day-of-year→month+day conversion,
  and {values: {...}} nesting patterns. Returns `ImportResult` with normalized months,
  weekdays, moons, seasons, eras, and settings.
- **calendar.templ**: Monthly grid, timeline view, event modal (create/edit with
  TipTap rich text editor + @mentions, optional time picker), upcoming events fragment,
  entity-events fragment, setup page with mode chooser (Real Life / Custom Fantasy /
  Import from File). Timeline renders rich HTML descriptions with `templ.Raw()`.
- **calendar_settings.templ**: 6-tab settings page (General, Months, Weekdays,
  Moons, Seasons, Eras) with Alpine.js list management. General tab includes time system
  configuration (hours/day, minutes/hour, seconds/minute) and current time. Seasons tab
  includes weather effect field per season. Eras tab manages named time periods with
  year ranges. Real-life mode hides Months/Weekdays/Eras tabs and date/time/leap-year
  fields. Export button in settings header.

## Data Model

- `calendars` — id, campaign_id, mode, name, description, epoch_name,
  current_year/month/day, hours_per_day, minutes_per_hour, seconds_per_minute,
  current_hour, current_minute, leap_year_every, leap_year_offset
- `calendar_months` — id, calendar_id, name, days, sort_order, is_intercalary,
  leap_year_days
- `calendar_weekdays` — id, calendar_id, name, sort_order
- `calendar_moons` — id, calendar_id, name, cycle_days, phase_offset, color
- `calendar_seasons` — id, calendar_id, name, start_month/day, end_month/day,
  description, color, weather_effect
- `calendar_eras` — id, calendar_id, name, start_year, end_year (nullable=ongoing),
  description, color, sort_order
- `calendar_events` — id, calendar_id, entity_id (FK), name, description (ProseMirror
  JSON for rich text, plain text for legacy), description_html (pre-rendered sanitized
  HTML), year/month/day, start_hour, start_minute, end_year/end_month/end_day, end_hour,
  end_minute, is_recurring, recurrence_type, visibility, category, created_by

## Time System

Calendars have a configurable time system with three parameters:
- **hours_per_day** (default 24) — How many hours in one day
- **minutes_per_hour** (default 60) — How many minutes in one hour
- **seconds_per_minute** (default 60) — How many seconds in one minute

Current time is tracked via `current_hour` and `current_minute`. The `AdvanceTime()`
service method handles rollover: minutes overflow into hours, hours overflow into
days (which then roll over months/years via the same logic as `AdvanceDate()`).

Events optionally have `start_hour/start_minute` and `end_hour/end_minute` (all
nullable). When set, times display on grid chips, timeline, and entity event lists.

## Calendar Modes

Two modes controlled by `calendars.mode`:

- **Fantasy** (`mode='fantasy'`, default): Full customization — arbitrary months,
  weekdays, time units, leap years. All settings tabs visible. Setup seeds generic
  12×30-day months and 7 weekdays.
- **Real-Life** (`mode='reallife'`): Gregorian calendar synced to wall clock.
  Setup seeds correct Gregorian months (Jan 31, Feb 28 +1 leap, etc.), weekdays
  (Sunday–Saturday), 24/60/60 time, leap year every 4. Settings page hides Months,
  Weekdays tabs and date/time/time-system/leap-year fields (Gregorian is fixed).
  Current date/time derived from `time.Now()` + user's IANA timezone.

User timezone stored in `users.timezone` (nullable, default UTC). Managed via
`GET /account` settings page.

## Rich Text Event Descriptions

Event descriptions use the same dual-storage pattern as entity entries:
- **`description`**: ProseMirror JSON (from TipTap `getJSON()`) — used for re-editing
- **`description_html`**: Pre-rendered sanitized HTML (from TipTap `getHTML()` + `sanitize.HTML()`) — used for display

The event create/edit modal embeds a compact TipTap editor instance (no headings,
just inline formatting + @mentions). The editor is initialized lazily on first modal
open. On form submit, both JSON and HTML are sent to the backend.

Legacy events with plain text descriptions (created before Sprint 10) are handled
gracefully: `HasRichText()` returns false, `PlainDescription()` returns the text as-is.
When editing a legacy event, the plain text is loaded into the TipTap editor as a paragraph.

Timeline view renders `description_html` via `templ.Raw()` for rich text events, or
falls back to plain text `<p>` for legacy events. Tooltips use `PlainDescription()`
which returns empty for rich text events (ProseMirror JSON is not user-readable).

## Key Design Decisions

- **One calendar per campaign** (unlike maps' many-per-campaign). Enforced in
  service CreateCalendar().
- **Bulk sub-resource updates**: SetMonths/SetWeekdays/SetMoons/SetSeasons/SetEras
  replace all records rather than individual CRUD — simpler client-side serialization.
- **Percentage-free date system**: Month days and leap year days are integers.
  Year length calculated by summing month days + per-month leap extras.
- **Moon phases**: Continuous 0.0–1.0 value from `cycle_days` and `phase_offset`.
  Mapped to 8 named phases (New, Waxing Crescent, etc.).
- **Season wrap-around**: `ContainsDate()` handles seasons crossing year boundary
  (e.g., Winter from month 11 to month 2).
- **Event categories**: holiday, battle, quest, birthday, festival, travel, custom.
  Each has an icon in the UI.
- **Dual views**: Monthly grid (default) and timeline (chronological, year-grouped).

## Routes

| Method | Path | Role | Handler |
|--------|------|------|---------|
| GET | /campaigns/:id/calendar | Player | Show |
| GET | /campaigns/:id/calendar/timeline | Player | ShowTimeline |
| GET | /campaigns/:id/calendar/entity-events/:eid | Player | EntityEventsFragment |
| GET | /campaigns/:id/calendar/upcoming | Player | UpcomingEventsFragment |
| POST | /campaigns/:id/calendar | Owner | CreateCalendar |
| DELETE | /campaigns/:id/calendar | Owner | DeleteCalendarAPI |
| GET | /campaigns/:id/calendar/settings | Owner | ShowSettings |
| PUT | /campaigns/:id/calendar/settings | Owner | UpdateCalendarAPI |
| PUT | /campaigns/:id/calendar/months | Owner | UpdateMonthsAPI |
| PUT | /campaigns/:id/calendar/weekdays | Owner | UpdateWeekdaysAPI |
| PUT | /campaigns/:id/calendar/moons | Owner | UpdateMoonsAPI |
| PUT | /campaigns/:id/calendar/seasons | Owner | UpdateSeasonsAPI |
| PUT | /campaigns/:id/calendar/eras | Owner | UpdateErasAPI |
| POST | /campaigns/:id/calendar/advance | Owner | AdvanceDateAPI |
| POST | /campaigns/:id/calendar/advance-time | Owner | AdvanceTimeAPI |
| GET | /campaigns/:id/calendar/export | Owner | ExportCalendarAPI |
| POST | /campaigns/:id/calendar/import | Owner | ImportCalendarAPI |
| POST | /campaigns/:id/calendar/import/preview | Owner | ImportPreviewAPI |
| POST | /campaigns/:id/calendar/import-setup | Owner | ImportFromSetupAPI |
| POST | /campaigns/:id/calendar/events | Scribe | CreateEventAPI |
| PUT | /campaigns/:id/calendar/events/:eid | Scribe | UpdateEventAPI |
| DELETE | /campaigns/:id/calendar/events/:eid | Owner | DeleteEventAPI |

## Import/Export

Calendar supports import from 4 external formats and export in Chronicle's native format.

### Supported Import Formats

| Format | Detection | Key Mapping |
|--------|-----------|-------------|
| **Chronicle** | `"format": "chronicle-calendar-v1"` | Native round-trip |
| **Simple Calendar** (Foundry VTT) | `"calendar"` key (v1) or `"exportVersion"` + `"calendars"` (v2) | `numberOfDays`→Days, `hoursInDay`→HoursPerDay, 0→1 indexed |
| **Calendaria** (Foundry VTT) | `"days.hoursPerDay"` or months-as-object | `days`/`leapDays`, day-of-year seasons, localization key stripping |
| **Fantasy-Calendar.com** | `"static_data"` + `"dynamic_data"` | `timespans`→Months, `global_week`→Weekdays, `cycle`→CycleDays |

### Export

`GET /campaigns/:id/calendar/export?events=true` returns JSON in Chronicle's native
format with all sub-resources + optional events. Settings page has download button.

### Import Flows

1. **Setup import** (`POST /calendar/import-setup`): Upload file during calendar
   creation. Creates new calendar + applies import + auto-enables addon.
2. **Existing calendar import** (`POST /calendar/import`): Replaces all sub-resources
   on an existing calendar. Destructive operation (months, weekdays, moons, seasons,
   eras all replaced).
3. **Preview** (`POST /calendar/import/preview`): Returns parsed preview without applying.

### Sync API

Import/export also available via REST API:
- `GET /api/v1/campaigns/:id/calendar/export` (read permission)
- `POST /api/v1/campaigns/:id/calendar/import` (write permission)

## Sync API Integration

Calendar has full REST API endpoints exposed through the sync-api plugin for external
tools (Foundry VTT). See `internal/plugins/syncapi/` for those routes.

## Dashboard Integration

- `calendar_preview` block type for campaign dashboard editor
- `GET /calendar/upcoming?limit=N` serves HTMX fragment with current date, season,
  and upcoming events
- Entity-event reverse lookup: `GET /calendar/entity-events/:eid` serves events
  linked to a specific entity (lazy-loaded on entity profile pages)
