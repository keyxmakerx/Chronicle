# Entities Plugin

<!-- Core plugin -- always enabled, cannot be disabled. -->

## Purpose

The heart of Chronicle. Manages the universal entity system where every
worldbuilding object (character, location, item, etc.) is an entity with
a configurable type. Handles entity CRUD, configurable entity types with
dynamic fields, entity search, nesting, and the entity profile page.

## Tier

Plugin (Core -- always enabled)

## Domain Concepts

- **Entity:** A worldbuilding object with a name, type, rich text entry,
  and configurable fields. Everything is an entity.
- **Entity Type:** A configurable template defining what fields an entity
  has. Per-campaign. Defaults ship pre-configured (Character, Location, etc.)
  but can be customized by the GM.
- **Fields Definition:** JSON array on entity_types defining field key, label,
  type, options, and display section.
- **Fields Data:** JSON object on an entity storing that entity's values for
  its type's fields.
- **Entry:** The rich text body of an entity (TipTap/ProseMirror JSON).
- **Privacy:** is_private flag makes an entity visible only to Scribes and Owners.
  Players see 404 for private entities.

## Files

| File | Purpose |
|------|---------|
| model.go | Entity, EntityType, FieldDefinition structs, DTOs, Slugify, ListOptions |
| repository.go | EntityTypeRepository + EntityRepository interfaces + MariaDB impls, SeedDefaults, FULLTEXT search, privacy-aware listing |
| service.go | EntityService (CRUD, slug gen, search, type management, SeedDefaults) -- also satisfies campaigns.EntityTypeSeeder |
| handler.go | 10 thin handlers: Index, NewForm, Create, Show, EditForm, Update, Delete, SearchAPI, GetEntry, UpdateEntryAPI |
| routes.go | Route registration with campaign middleware + shortcut routes (/characters, /locations, etc.) |
| index.templ | Entity list page with type filter sidebar + entity grid |
| entity_card.templ | Single entity card component with type badge and privacy indicator |
| show.templ | Entity profile page (sidebar fields + main content area) |
| form.templ | Create/edit form with dynamic field rendering from entity type |
| search_results.templ | HTMX fragment for search results |

## Dependencies

- **Uses:** auth (GetUserID), campaigns (GetCampaignContext, RequireCampaignAccess, RequireRole, role constants), middleware (IsHTMX, Render, GetCSRFToken), apperror, layouts
- **Used by:** campaigns (EntityTypeSeeder interface -- seeds defaults on campaign creation), widgets (editor, tags -- future), modules (tooltips -- future)

## Routes

| Method | Path | Handler | Min Role | Description |
|--------|------|---------|----------|-------------|
| GET | /campaigns/:id/entities | Index | Player | List entities (filterable by type) |
| GET | /campaigns/:id/entities/search | SearchAPI | Player | Search entities (HTMX fragment) |
| GET | /campaigns/:id/entities/:eid | Show | Player | Entity profile page |
| GET | /campaigns/:id/entities/new | NewForm | Scribe | Create entity form |
| POST | /campaigns/:id/entities | Create | Scribe | Create entity |
| GET | /campaigns/:id/entities/:eid/edit | EditForm | Scribe | Edit entity form |
| PUT | /campaigns/:id/entities/:eid | Update | Scribe | Update entity |
| DELETE | /campaigns/:id/entities/:eid | Delete | Owner | Delete entity |
| GET | /campaigns/:id/entities/:eid/entry | GetEntry | Player | Get entry JSON for editor |
| PUT | /campaigns/:id/entities/:eid/entry | UpdateEntryAPI | Scribe | Save entry JSON from editor |
| GET | /campaigns/:id/characters | Index | Player | Shortcut: type=character |
| GET | /campaigns/:id/locations | Index | Player | Shortcut: type=location |
| GET | /campaigns/:id/organizations | Index | Player | Shortcut: type=organization |
| GET | /campaigns/:id/items | Index | Player | Shortcut: type=item |
| GET | /campaigns/:id/notes | Index | Player | Shortcut: type=note |
| GET | /campaigns/:id/events | Index | Player | Shortcut: type=event |

## Business Rules

- Entity names must be non-empty (max 200 chars)
- Slug auto-generated from name, deduplicated with -2/-3 suffix, unique per campaign
- Entity type determines which fields appear in the profile and edit form
- Dynamic fields parsed from form params (field_<key>) by handler
- Private entities (is_private=true) filtered at SQL level: Players don't see them
- Show handler returns 404 (not 403) for private entities to avoid revealing existence
- FULLTEXT search on entity name (BOOLEAN MODE), LIKE fallback for queries < 4 chars
- Deleting an entity cascades via FK (future: posts, tags, relations)
- Default entity types seeded on campaign creation via EntityTypeSeeder interface
- 6 default types: Character, Location, Organization, Item, Note, Event

## Current State

- [x] .ai.md created
- [x] Migration written (000004)
- [x] Entity model defined (Entity, EntityType, FieldDefinition)
- [x] Entity type model defined with default types
- [x] Repository with CRUD queries + FULLTEXT search + privacy filtering
- [x] Service layer (CRUD, slug gen, search, seeder)
- [x] Handler integration (8 handlers)
- [x] Templates (index, card, show, form, search_results)
- [x] Entity type seed data (6 default types)
- [x] Search implementation (FULLTEXT + LIKE fallback)
- [x] Routes defined with shortcut routes
- [x] Integrated with campaigns (EntityTypeSeeder) and app router
- [ ] Tests written

## Notes

- The entity profile page composes multiple widgets: title, editor, tags,
  attributes. The page itself is a Templ template that provides mount points.
- Entity type customization UI (drag-drop field editor) is Phase 3.
- For Phase 1, entity types are seeded and edited via DB/admin only.
- Rich text editor (TipTap) is now integrated via the editor widget. Entity
  show.templ mounts the widget with `data-widget="editor"` which loads content
  from the entry API endpoints and supports autosave.
