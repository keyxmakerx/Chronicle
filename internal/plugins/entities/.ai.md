# Entities Plugin

<!-- Core plugin -- always enabled, cannot be disabled. -->

## Purpose

The heart of Chronicle. Manages the universal entity system where every
worldbuilding object (character, location, item, etc.) is an entity with
a configurable type. Handles entity CRUD, configurable entity types with
dynamic fields, entity search, nesting, and the entity profile page.

## Tier

Plugin (Core -- always enabled)

## Domain Concepts

- **Entity:** A worldbuilding object with a name, type, rich text entry,
  and configurable fields. Everything is an entity.
- **Entity Type:** A configurable template defining what fields an entity
  has. Per-campaign. Defaults ship pre-configured (Character, Location, etc.)
  but can be customized by the GM.
- **Fields Definition:** JSON array on entity_types defining field key, label,
  type, options, and display section.
- **Fields Data:** JSON object on an entity storing that entity's values for
  its type's fields.
- **Entry:** The rich text body of an entity (TipTap/ProseMirror JSON).

## Files

| File | Purpose |
|------|---------|
| handler.go | Entity CRUD + entity type management handlers |
| service.go | Entity business logic, type validation, search |
| repository.go | Entity + entity_types MariaDB queries |
| model.go | Entity, EntityType, field definition structs |
| routes.go | Entity routes (nested under /campaigns/:cid/) |
| templates/ | Entity list (grid), profile page, forms |

## Dependencies

- **Uses:** auth, campaigns, internal/database
- **Used by:** widgets (editor, tags, attributes, mentions), modules (tooltips)

## Routes

| Method | Path | Handler | Description |
|--------|------|---------|-------------|
| GET | /campaigns/:cid/entities | Index | List entities (filterable by type) |
| GET | /campaigns/:cid/entities/new | NewForm | Create entity form |
| POST | /campaigns/:cid/entities | Create | Create entity |
| GET | /campaigns/:cid/entities/:eid | Show | Entity profile page |
| GET | /campaigns/:cid/entities/:eid/edit | EditForm | Edit entity form |
| PUT | /campaigns/:cid/entities/:eid | Update | Update entity |
| DELETE | /campaigns/:cid/entities/:eid | Delete | Delete entity |
| GET | /campaigns/:cid/characters | Index | Shortcut: type=character |
| GET | /campaigns/:cid/locations | Index | Shortcut: type=location |

## Business Rules

- Entity names must be non-empty
- Slug auto-generated from name, unique per campaign
- Entity type determines which fields appear in the profile and edit form
- Fields data is validated against the entity type's field definitions
- Entry content is sanitized server-side (bluemonday) before rendering
- Deleting an entity cascades to posts, tags, relations, permissions
- FULLTEXT search on entity name
- Entity profile page layout: sidebar (fields) + main (entry + posts)

## Current State

- [ ] .ai.md created
- [ ] Entity model defined
- [ ] Entity type model defined
- [ ] Repository with CRUD queries
- [ ] Service layer
- [ ] Handler integration
- [ ] Templates (list, profile, form)
- [ ] Entity type seed data
- [ ] Search implementation
- [ ] Tests

## Notes

- The entity profile page composes multiple widgets: title, editor, tags,
  attributes. The page itself is a Templ template that provides mount points.
- Entity type customization UI (drag-drop field editor) is Phase 3.
- For Phase 1, entity types are seeded and edited via DB/admin only.
