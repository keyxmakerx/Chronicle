# Entities Plugin

<!-- Core plugin -- always enabled, cannot be disabled. -->

## Purpose

The heart of Chronicle. Manages the universal entity system where every
worldbuilding object (character, location, item, etc.) is an entity with
a configurable type. Handles entity CRUD, configurable entity types with
dynamic fields, entity search, nesting, and the entity profile page.

## Tier

Plugin (Core -- always enabled)

## Domain Concepts

- **Entity:** A worldbuilding object with a name, type, rich text entry,
  and configurable fields. Everything is an entity.
- **Entity Type:** A configurable template defining what fields an entity
  has. Per-campaign. Defaults ship pre-configured (Character, Location, etc.)
  but can be customized by the GM.
- **Fields Definition:** JSON array on entity_types defining field key, label,
  type, options, and display section.
- **Fields Data:** JSON object on an entity storing that entity's values for
  its type's fields.
- **Entry:** The rich text body of an entity (TipTap/ProseMirror JSON).
- **Privacy:** is_private flag makes an entity visible only to Scribes and Owners.
  Players see 404 for private entities.

## Files

| File | Purpose |
|------|---------|
| model.go | Entity, EntityType, FieldDefinition structs, DTOs, Slugify, ListOptions |
| repository.go | EntityTypeRepository + EntityRepository interfaces + MariaDB impls, SeedDefaults, FULLTEXT search, privacy-aware listing |
| service.go | EntityService (CRUD, slug gen, search, type management, SeedDefaults) -- also satisfies campaigns.EntityTypeSeeder |
| handler.go | Thin handlers: CRUD (Index, NewForm, Create, Show, EditForm, Update, Delete), Search, Entry API, Fields API, Field Overrides API, Image API, Preview API, Popup Config API, Entity Type CRUD, Layout/Color/Dashboard APIs |
| routes.go | Route registration with campaign middleware + shortcut routes (/characters, /locations, etc.) |
| index.templ | Entity list page with horizontal tab navigation + entity grid |
| entity_card.templ | Entity card with type badge, privacy indicator, preview tooltip |
| show.templ | Entity profile page (sidebar fields + main content area) |
| form.templ | Create/edit form with dynamic field rendering and popup config section |
| search_results.templ | HTMX fragment for search results |
| category_dashboard.templ | Category dashboard with grid/table/tree views |

## Dependencies

- **Uses:** auth (GetUserID), campaigns (GetCampaignContext, RequireCampaignAccess, RequireRole, role constants), middleware (IsHTMX, Render, GetCSRFToken), apperror, layouts
- **Used by:** campaigns (EntityTypeSeeder interface -- seeds defaults on campaign creation), widgets (editor, tags -- future), modules (tooltips -- future)

## Routes

| Method | Path | Handler | Min Role | Description |
|--------|------|---------|----------|-------------|
| GET | /campaigns/:id/entities | Index | Player | List entities (filterable by type) |
| GET | /campaigns/:id/entities/search | SearchAPI | Player | Search entities (HTMX fragment) |
| GET | /campaigns/:id/entities/:eid | Show | Player | Entity profile page |
| GET | /campaigns/:id/entities/new | NewForm | Scribe | Create entity form |
| POST | /campaigns/:id/entities | Create | Scribe | Create entity |
| GET | /campaigns/:id/entities/:eid/edit | EditForm | Scribe | Edit entity form |
| PUT | /campaigns/:id/entities/:eid | Update | Scribe | Update entity |
| DELETE | /campaigns/:id/entities/:eid | Delete | Owner | Delete entity |
| GET | /campaigns/:id/entities/:eid/entry | GetEntry | Player | Get entry JSON for editor |
| PUT | /campaigns/:id/entities/:eid/entry | UpdateEntryAPI | Scribe | Save entry JSON from editor |
| GET | /campaigns/:id/entities/:eid/fields | GetFieldsAPI | Player | Get entity fields (JSON) |
| PUT | /campaigns/:id/entities/:eid/fields | UpdateFieldsAPI | Scribe | Update entity fields (JSON) |
| PUT | /campaigns/:id/entities/:eid/field-overrides | UpdateFieldOverridesAPI | Scribe | Per-entity field customizations |
| PUT | /campaigns/:id/entities/:eid/image | UpdateImageAPI | Scribe | Update entity header image |
| PUT | /campaigns/:id/entities/:eid/popup-config | UpdatePopupConfigAPI | Scribe | Per-entity hover preview config |
| GET | /campaigns/:id/entities/:eid/preview | PreviewAPI | Player | Tooltip preview data (JSON) |
| GET | /campaigns/:id/entity-types | EntityTypesPage | Owner | Entity type management page |
| POST | /campaigns/:id/entity-types | CreateEntityType | Owner | Create entity type |
| PUT | /campaigns/:id/entity-types/:etid | UpdateEntityTypeAPI | Owner | Update entity type |
| DELETE | /campaigns/:id/entity-types/:etid | DeleteEntityType | Owner | Delete entity type |
| GET | /campaigns/:id/entity-types/:etid/config | EntityTypeConfig | Owner | Unified config page |
| GET | /campaigns/:id/entity-types/:etid/customize | EntityTypeCustomizeFragment | Owner | Customize Hub fragment |
| GET | /campaigns/:id/entity-types/:etid/layout | GetEntityTypeLayout | Owner | Get layout JSON |
| PUT | /campaigns/:id/entity-types/:etid/layout | UpdateEntityTypeLayout | Owner | Save layout JSON |
| PUT | /campaigns/:id/entity-types/:etid/color | UpdateEntityTypeColor | Owner | Save display color |
| PUT | /campaigns/:id/entity-types/:etid/dashboard | UpdateEntityTypeDashboard | Owner | Save dashboard config |
| GET | /campaigns/:id/entity-types/:etid/dashboard-layout | GetCategoryDashboardLayout | Owner | Get dashboard layout |
| PUT | /campaigns/:id/entity-types/:etid/dashboard-layout | UpdateCategoryDashboardLayout | Owner | Save dashboard layout |
| DELETE | /campaigns/:id/entity-types/:etid/dashboard-layout | ResetCategoryDashboardLayout | Owner | Reset to default layout |
| GET | /campaigns/:id/:typeSlug | Index (dynamic) | Player | Category dashboard by slug |

## Business Rules

- Entity names must be non-empty (max 200 chars)
- Slug auto-generated from name, deduplicated with -2/-3 suffix, unique per campaign
- Entity type determines which fields appear in the profile and edit form
- Dynamic fields parsed from form params (field_<key>) by handler
- Private entities (is_private=true) filtered at SQL level: Players don't see them
- Show handler returns 404 (not 403) for private entities to avoid revealing existence
- FULLTEXT search on entity name (BOOLEAN MODE), LIKE fallback for queries < 4 chars
- Deleting an entity cascades via FK (future: posts, tags, relations)
- Default entity types seeded on campaign creation via EntityTypeSeeder interface
- 6 default types: Character, Location, Organization, Item, Note, Event

## Current State

- [x] .ai.md created
- [x] Migration written (000004)
- [x] Entity model defined (Entity, EntityType, FieldDefinition)
- [x] Entity type model defined with default types
- [x] Repository with CRUD queries + FULLTEXT search + privacy filtering + UpdateFields
- [x] Service layer (CRUD, slug gen, search, seeder, UpdateFields)
- [x] Handler integration (12 handlers including GetFieldsAPI, UpdateFieldsAPI)
- [x] Templates (index, card, show, form, search_results) -- all using semantic color tokens
- [x] Entity type seed data (6 default types)
- [x] Search implementation (FULLTEXT + LIKE fallback)
- [x] Routes defined with shortcut routes + fields API routes
- [x] Integrated with campaigns (EntityTypeSeeder) and app router
- [x] Entity type CRUD UI (create, edit, delete with icon/color/fields management)
- [x] Entity list redesign (horizontal tabs, search bar, stats subtitle)
- [x] Entity image upload pipeline (media plugin integration)
- [x] Layout-driven profile pages (reads layout_json from entity type)
- [x] Descriptor rename (Subtype Label -> Descriptor)
- [x] Dark mode support via semantic color tokens
- [x] Per-entity popup_config for hover preview customization
- [x] Preview API with attributes, image, entry excerpt (respects popup_config)
- [x] Entity tooltip widget with gradient-bordered image + side-by-side attributes layout
- [x] Unit tests (39+ tests in service_test.go)
- [ ] Additional test coverage for newer features (fields API, entity types, popup config)

## Notes

- The entity profile page composes multiple widgets: title, editor, tags,
  attributes, relations. The page itself is a Templ template that provides mount points.
- Entity type customization is fully implemented with a visual config UI.
- Rich text editor (TipTap) is integrated via the editor widget with view/edit
  mode toggle. Entity show.templ mounts the widget with `data-widget="editor"`.
- Attributes widget mounts with `data-widget="attributes"` for inline field editing.
- Tags and relations widgets also mount on entity profile pages.
