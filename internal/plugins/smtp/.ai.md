# SMTP Plugin

## Purpose

Provides outbound email functionality for Chronicle. Used for password resets,
campaign ownership transfer emails, and any future notification needs.

## Tier

Plugin (Infrastructure -- admin-managed, used by other plugins)

## Domain Concepts

- **SMTP Settings:** Singleton configuration stored in the database. Only one
  row (id=1) exists. Managed by site admins via `/admin/smtp`.
- **MailService:** The cross-plugin interface. Other plugins (campaigns, auth)
  depend on this interface to send email. May be nil if not wired.
- **Password Security:** SMTP password is encrypted with AES-256-GCM using
  SHA-256(SECRET_KEY) as the encryption key. The password is NEVER returned
  to the UI -- only a `HasPassword` boolean.

## Files

| File | Purpose |
|------|---------|
| model.go | SMTPSettings, smtpRow, UpdateSMTPRequest, Mail |
| crypto.go | AES-256-GCM encrypt/decrypt using deriveKey(secret) |
| repository.go | Get/Upsert singleton row from smtp_settings table |
| service.go | MailService + SMTPService (send mail, manage settings, test connection) |
| handler.go | Settings GET/PUT, TestConnection POST |
| routes.go | Routes under /admin/smtp (admin group) |
| settings.templ | SMTP settings form with password handling |

## Dependencies

- **Uses:** config (SECRET_KEY for encryption)
- **Used by:** campaigns (transfer emails), auth (future password resets)

## Routes

| Method | Path | Handler | Description |
|--------|------|---------|-------------|
| GET | /admin/smtp | Settings | SMTP settings form |
| PUT | /admin/smtp | UpdateSettings | Save SMTP settings |
| POST | /admin/smtp/test | TestConnection | Test SMTP connectivity |

## Security Rules

- Password is encrypted with AES-256-GCM before storage
- Password is decrypted only at send time, never cached in plaintext
- Password is NEVER returned to the UI (HasPassword bool only)
- Empty password on update = keep existing encrypted password
- SECRET_KEY rotation makes stored SMTP password unrecoverable (admin re-enters)

## Current State

- [x] .ai.md created
- [x] Migration written (000003)
- [x] Model + crypto implemented
- [x] Repository implemented
- [x] Service implemented (MailService + SMTPService)
- [x] Handler implemented
- [x] Template created
- [x] Routes defined
- [ ] Integrated with main router
- [ ] Tests written
