# Settings Plugin

## Purpose

Site-wide configuration management for Chronicle, focused on storage limits.
Provides a key-value store for global settings (site_settings table), per-user
upload/storage overrides, and per-campaign storage/file-count overrides. The
resolution order for effective limits is: per-campaign > per-user > global.

## Tier

Plugin (Admin-only -- registered on the /admin group)

## Domain Concepts

- **GlobalStorageLimits:** Site-wide defaults for upload size, storage per user/campaign, file counts, rate limits.
- **UserStorageLimit:** Per-user override (NULL fields inherit global). Stored in user_storage_limits table.
- **CampaignStorageLimit:** Per-campaign override (NULL fields inherit user/global). Stored in campaign_storage_limits table.
- **EffectiveLimits:** Resolved limits after merging all tiers. Used at upload time.
- **Override Priority:** per-campaign > per-user > global. Value of 0 = unlimited.

## Files

| File | Purpose |
|------|---------|
| model.go | SiteSetting, UserStorageLimit, CampaignStorageLimit, GlobalStorageLimits, EffectiveLimits |
| repository.go | SQL queries for site_settings, user_storage_limits, campaign_storage_limits |
| service.go | Validation, limit resolution, CRUD for all tiers |
| handler.go | Form rendering and submission handlers |
| routes.go | Admin group routes for global, user, and campaign limits |
| storage_settings.templ | Settings page with global form, user/campaign override tables |

## Dependencies

- **Uses:** auth (GetUserID for audit logging), middleware (Render, IsHTMX, GetCSRFToken), apperror
- **Used by:** media plugin should call GetEffectiveLimits at upload time

## Routes

| Method | Path | Handler | Description |
|--------|------|---------|-------------|
| GET | /admin/storage/settings | StorageSettings | Settings page |
| POST | /admin/storage/settings | UpdateStorageSettings | Save global settings |
| PUT | /admin/users/:id/storage | SetUserStorageLimit | Set per-user override |
| DELETE | /admin/users/:id/storage | DeleteUserStorageLimit | Remove per-user override |
| PUT | /admin/campaigns/:id/storage | SetCampaignStorageLimit | Set per-campaign override |
| DELETE | /admin/campaigns/:id/storage | DeleteCampaignStorageLimit | Remove per-campaign override |

## Current State

- [x] .ai.md created
- [x] Model defined
- [x] Repository implemented
- [x] Service implemented with limit resolution
- [x] Handler implemented
- [x] Routes defined
- [x] Settings page template with global form and override tables
- [x] Integrated with main router via admin group
- [ ] Media plugin wired to use GetEffectiveLimits
- [ ] Tests written
