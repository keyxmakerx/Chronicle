# Sessions Plugin

Game session scheduling and RSVP tracking for campaigns. Sessions represent
real-world play sessions (game nights) with attendee management and entity linking.

## Architecture

- **model.go**: Session, Attendee, SessionEntity structs + DTOs.
  Status constants: `planned`, `completed`, `cancelled`.
  RSVP constants: `invited`, `accepted`, `declined`, `tentative`.
  Entity role constants: `mentioned`, `encountered`, `key`.
- **repository.go**: SQL CRUD for sessions + attendees + entity linking.
  ListByCampaign sorts planned first, then by scheduled_date. AddAttendee
  uses ON DUPLICATE KEY UPDATE for upsert.
- **service.go**: Validation, CRUD orchestration, InviteAll for batch invites,
  RSVP status updates, entity linking with role validation.
- **handler.go**: HTTP handlers for list, detail, create, update, delete,
  RSVP, entity link/unlink. MemberLister interface for cross-plugin
  dependency (auto-invite campaign members). HTMX-aware responses.
- **routes.go**: Route registration with role middleware.
- **sessions.templ**: List page with status grouping (Upcoming/Completed/Cancelled),
  detail page with attendee list and RSVP buttons, create modal.

## Data Model

- `sessions` — id, campaign_id, name, summary, notes, notes_html,
  scheduled_date, calendar_year/month/day, status, sort_order,
  created_by, created_at, updated_at
- `session_attendees` — id, session_id, user_id, status (invited/accepted/
  declined/tentative), responded_at
- `session_entities` — id, session_id, entity_id, role (mentioned/
  encountered/key)

## Cross-Plugin Dependencies

- **campaigns**: MemberLister interface provides ListMembers() for auto-inviting
  all campaign members when a session is created.
- **addons**: Registered as addon slug "sessions" — must be enabled per campaign.

## Routes

| Method | Path | Role | Handler |
|--------|------|------|---------|
| GET | /campaigns/:id/sessions | Player | ListSessions |
| GET | /campaigns/:id/sessions/:sid | Player | ShowSession |
| POST | /campaigns/:id/sessions | Scribe | CreateSession |
| PUT | /campaigns/:id/sessions/:sid | Scribe | UpdateSessionAPI |
| DELETE | /campaigns/:id/sessions/:sid | Owner | DeleteSessionAPI |
| POST | /campaigns/:id/sessions/:sid/rsvp | Player | RSVPSession |
| POST | /campaigns/:id/sessions/:sid/entities | Scribe | LinkEntityAPI |
| DELETE | /campaigns/:id/sessions/:sid/entities/:eid | Scribe | UnlinkEntityAPI |

## RSVP Flow

1. Session created → all campaign members auto-invited (status: `invited`)
2. Players see session with RSVP buttons (Going / Maybe / Can't Make It)
3. RSVP updates via HTMX POST, returns refreshed attendee list fragment
4. Session detail shows attendee count summary (e.g., "3/5 going")

## Key Design Decisions

- **Separate from calendar events**: Sessions are their own entity, not calendar
  events. This keeps the calendar clean for in-world events while sessions
  track real-world scheduling.
- **Auto-invite on create**: All campaign members are automatically invited when
  a session is created, reducing manual setup.
- **IDOR protection**: `requireSessionInCampaign()` verifies session belongs to
  the campaign in the URL path before any operation.
- **Upsert attendees**: AddAttendee uses ON DUPLICATE KEY UPDATE so re-inviting
  or changing RSVP is idempotent.
