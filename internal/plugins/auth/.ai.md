# Auth Plugin

<!-- Core plugin -- always enabled, cannot be disabled. -->

## Purpose

Handles user authentication, session management, and password security for
Chronicle. Provides login, registration, logout, and session validation.
All other plugins depend on auth for user context.

## Tier

Plugin (Core -- always enabled)

## Domain Concepts

- **User:** A registered account with email, password, and profile info.
- **Session:** A server-side record (stored in Redis) linking a cookie to a user.
- **Session Token:** 32-byte random hex token stored in `chronicle_session` cookie.

## Files

| File | Purpose |
|------|---------|
| model.go | User domain model, request/input DTOs, Session struct |
| repository.go | UserRepository interface + MariaDB impl (Create, FindByID, FindByEmail, EmailExists, UpdateLastLogin) |
| service.go | AuthService with Register (argon2id + UUID), Login (verify + Redis session), ValidateSession, DestroySession |
| handler.go | Thin HTTP handlers for login/register/logout with HTMX support |
| middleware.go | RequireAuth middleware, GetSession/GetUserID context helpers |
| routes.go | Public route registration on Echo instance |
| login.templ | Login page + form component (HTMX partial swap on error) |
| register.templ | Register page + form component (HTMX partial swap on error) |

## Dependencies

- **Uses:** internal/apperror, internal/middleware (Render, IsHTMX, GetCSRFToken), golang.org/x/crypto/argon2, github.com/redis/go-redis/v9
- **Used by:** Every other plugin (via RequireAuth middleware, GetSession/GetUserID helpers)

## Routes

| Method | Path | Handler | Auth? | Description |
|--------|------|---------|-------|-------------|
| GET | /login | LoginForm | No | Show login page |
| POST | /login | Login | No | Process login |
| GET | /register | RegisterForm | No | Show registration page |
| POST | /register | Register | No | Process registration |
| POST | /logout | Logout | Yes | Destroy session |

## Business Rules

- Passwords hashed with argon2id (memory-hard, GPU-resistant)
- Sessions stored in Redis with configurable TTL (default 30 days)
- Login rate limiting: max 5 attempts per minute per IP
- Email must be unique (case-insensitive)
- Password minimum 8 characters

## Current State

- [x] .ai.md created
- [x] Handler implemented (login/register/logout with HTMX support)
- [x] Service implemented (Register, Login, ValidateSession, DestroySession)
- [x] Repository implemented (Create, FindByID, FindByEmail, EmailExists, UpdateLastLogin)
- [x] Templates created (login.templ, register.templ with HTMX partial swap)
- [ ] Tests written
- [x] Auth middleware implemented (RequireAuth, GetSession, GetUserID)
- [x] Integrated with main router (app/routes.go wires DI)

## Notes

- 2FA/TOTP is planned for Phase 3, not Phase 1.
- API token auth (Personal Access Tokens) is separate from session auth.
