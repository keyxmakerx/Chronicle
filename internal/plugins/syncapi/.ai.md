# Sync API Plugin

## Purpose
Provides a secure REST API for external tool integration. External clients
(Foundry VTT, custom scripts, etc.) authenticate with API keys and can
read/write campaign data through versioned endpoints.

## Architecture
Standard plugin: handler → service → repository → MariaDB.
Additionally provides API authentication middleware for the `/api/v1` routes.

### Files
- `model.go` — Domain types: APIKey, APIRequestLog, SecurityEvent, IPBlock, stats.
- `repository.go` — SQL operations for all sync API tables.
- `service.go` — Business logic: key generation (bcrypt), auth, rate limiting, logging.
- `handler.go` — HTTP handlers for management UI (admin dashboard + owner key pages).
- `api_handler.go` — REST API v1 endpoint handlers (read, write, sync).
- `middleware.go` — API key auth, permission checks, campaign match, rate limiting.
- `routes.go` — Route registration: admin, campaign, and /api/v1 endpoints.
- `owner_keys.templ` — Campaign owner key management page.
- `admin_dashboard.templ` — Admin API monitoring dashboard.

### Database Tables
- `api_keys` — API key registry (bcrypt-hashed keys, per-campaign, per-user).
- `api_request_log` — Request audit trail (method, path, status, IP, latency).
- `api_security_events` — Security events (rate_limit, auth_failure, ip_blocked, etc.).
- `api_ip_blocklist` — Admin-managed IP blocklist.

### Routes

**Admin (site admin only):**
- `GET /admin/api` — API monitoring dashboard
- `GET /admin/api/logs` — Request logs JSON
- `GET /admin/api/security` — Security events JSON
- `PUT /admin/api/security/:eventID/resolve` — Resolve security event
- `POST /admin/api/ip-blocks` — Block an IP
- `DELETE /admin/api/ip-blocks/:blockID` — Unblock an IP
- `PUT /admin/api/keys/:keyID/toggle` — Admin activate/deactivate key
- `DELETE /admin/api/keys/:keyID` — Admin revoke key

**Campaign (campaign owner only):**
- `GET /campaigns/:id/api-keys` — Key management page
- `POST /campaigns/:id/api-keys` — Create new API key
- `PUT /campaigns/:id/api-keys/:keyID/toggle` — Toggle key active/inactive
- `DELETE /campaigns/:id/api-keys/:keyID` — Revoke key

**REST API v1 (API key auth):**
- `GET /api/v1/campaigns/:id` — Campaign details (read)
- `GET /api/v1/campaigns/:id/entity-types` — List entity types (read)
- `GET /api/v1/campaigns/:id/entity-types/:typeID` — Get entity type (read)
- `GET /api/v1/campaigns/:id/entities` — List entities (read, supports ?q=&type_id=&page=&per_page=)
- `GET /api/v1/campaigns/:id/entities/:entityID` — Get entity (read)
- `POST /api/v1/campaigns/:id/entities` — Create entity (write)
- `PUT /api/v1/campaigns/:id/entities/:entityID` — Update entity (write)
- `PUT /api/v1/campaigns/:id/entities/:entityID/fields` — Update fields only (write)
- `DELETE /api/v1/campaigns/:id/entities/:entityID` — Delete entity (write)
- `POST /api/v1/campaigns/:id/sync` — Bulk bidirectional sync (sync)

## Security Design
- API keys are generated with `crypto/rand` (32 bytes + "chron_" prefix)
- Keys are bcrypt-hashed; plaintext shown once at creation, never stored
- Key prefix (first 8 chars) stored for lookup without exposing full key
- Per-key rate limits (configurable, default 60 req/min)
- Optional IP allowlist per key (CIDR notation)
- Optional key expiry dates
- Admin IP blocklist checked before processing any API request
- All requests logged with IP, user agent, status, latency
- Security events auto-logged for rate limits, auth failures, blocked IPs

## Middleware Stack
API v1 requests pass through this middleware chain:
1. `RequireAPIKey` — Extract + validate Bearer token, check IP blocklist, log request.
2. `RateLimit` — Fixed-window per-minute rate limiter with X-RateLimit headers.
3. `RequireCampaignMatch` — Ensure key's campaign matches URL :id param.
4. `RequirePermission` — Check key has the required permission (read/write/sync).

## Dependencies
- `campaigns` — For campaign context middleware, role checks, and campaign info.
- `entities` — For entity CRUD operations in API v1 endpoints.
- `auth` — For authentication middleware.
- `apperror` — For domain error types.
- `golang.org/x/crypto/bcrypt` — For key hashing.
