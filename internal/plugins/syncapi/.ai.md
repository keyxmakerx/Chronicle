# Sync API Plugin

## Purpose
Provides a secure REST API for external tool integration. External clients
(Foundry VTT, custom scripts, etc.) authenticate with API keys and can
read/write campaign data through versioned endpoints.

## Architecture
Standard plugin: handler → service → repository → MariaDB.
Additionally provides API authentication middleware for the `/api/v1` routes.

### Files
- `model.go` — Domain types: APIKey, APIRequestLog, SecurityEvent, IPBlock, stats.
- `repository.go` — SQL operations for all sync API tables.
- `service.go` — Business logic: key generation (bcrypt), auth, rate limiting, logging.
- `handler.go` — HTTP handlers for management UI + API endpoints.
- `routes.go` — Route registration: admin monitoring + campaign key management.
- `owner_keys.templ` — Campaign owner key management page.
- `admin_dashboard.templ` — Admin API monitoring dashboard.

### Database Tables
- `api_keys` — API key registry (bcrypt-hashed keys, per-campaign, per-user).
- `api_request_log` — Request audit trail (method, path, status, IP, latency).
- `api_security_events` — Security events (rate_limit, auth_failure, ip_blocked, etc.).
- `api_ip_blocklist` — Admin-managed IP blocklist.

### Routes

**Admin (site admin only):**
- `GET /admin/api` — API monitoring dashboard
- `GET /admin/api/logs` — Request logs JSON
- `GET /admin/api/security` — Security events JSON
- `PUT /admin/api/security/:eventID/resolve` — Resolve security event
- `POST /admin/api/ip-blocks` — Block an IP
- `DELETE /admin/api/ip-blocks/:blockID` — Unblock an IP
- `PUT /admin/api/keys/:keyID/toggle` — Admin activate/deactivate key
- `DELETE /admin/api/keys/:keyID` — Admin revoke key

**Campaign (campaign owner only):**
- `GET /campaigns/:id/api-keys` — Key management page
- `POST /campaigns/:id/api-keys` — Create new API key
- `PUT /campaigns/:id/api-keys/:keyID/toggle` — Toggle key active/inactive
- `DELETE /campaigns/:id/api-keys/:keyID` — Revoke key

## Security Design
- API keys are generated with `crypto/rand` (32 bytes + "chron_" prefix)
- Keys are bcrypt-hashed; plaintext shown once at creation, never stored
- Key prefix (first 8 chars) stored for lookup without exposing full key
- Per-key rate limits (configurable, default 60 req/min)
- Optional IP allowlist per key (CIDR notation)
- Optional key expiry dates
- Admin IP blocklist checked before processing any API request
- All requests logged with IP, user agent, status, latency
- Security events auto-logged for rate limits, auth failures, blocked IPs

## Dependencies
- `campaigns` — For campaign context middleware and role checks.
- `auth` — For authentication middleware.
- `apperror` — For domain error types.
- `golang.org/x/crypto/bcrypt` — For key hashing.
