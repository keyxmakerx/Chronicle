# Maps Plugin

Interactive map support for campaigns using Leaflet.js. Each campaign can have
multiple maps (world, region, city, dungeon). Maps have a background image and
positioned pin markers that optionally link to entities.

## Architecture

- **model.go**: Map, Marker structs + DTOs (MapViewData, MapListData)
- **repository.go**: SQL CRUD for maps and markers. Entity JOIN for marker display.
  Visibility filtering by role (role >= 3 sees dm_only markers).
- **service.go**: Validation, defaults, CRUD orchestration. No Echo types.
- **handler.go**: HTTP handlers (Index, Show, CRUD APIs). Campaign context + role checking.
- **routes.go**: Route registration with role middleware.
- **maps.templ**: Map list page, Leaflet.js viewer, marker/settings modals.

## Data Model

- `maps` — id, campaign_id, name, description, image_id (FK to media_files),
  image_width, image_height, sort_order
- `map_markers` — id, map_id, name, description, x/y (percentage 0-100),
  icon, color, entity_id (FK to entities), visibility, created_by

## Key Design Decisions

- **Multiple maps per campaign** (unlike calendar's 1:1). Maps are listed on an
  index page with card grid.
- **Percentage coordinates** (0-100 for x and y) — independent of image resolution.
  Leaflet CRS.Simple converts to pixel space at render time.
- **Media integration**: Map images uploaded via existing media plugin (`/media/upload`).
  Served via `/media/:id`. Image dimensions stored on map for coordinate space.
- **Leaflet loaded per-page**: CSS+JS from CDN only on map viewer pages, not globally.
- **Draggable markers**: Scribe+ markers are draggable. Silent PUT on dragend.
- **Place mode**: Toggle button switches cursor to crosshair. Click places new marker.

## Routes

| Method | Path | Role | Handler |
|--------|------|------|---------|
| GET | /campaigns/:id/maps | Player | Index |
| GET | /campaigns/:id/maps/:mid | Player | Show |
| POST | /campaigns/:id/maps/new | Owner | CreateMapForm |
| POST | /campaigns/:id/maps | Owner | CreateMapAPI |
| PUT | /campaigns/:id/maps/:mid | Owner | UpdateMapAPI |
| DELETE | /campaigns/:id/maps/:mid | Owner | DeleteMapAPI |
| POST | /campaigns/:id/maps/:mid/markers | Scribe | CreateMarkerAPI |
| PUT | /campaigns/:id/maps/:mid/markers/:mkid | Scribe | UpdateMarkerAPI |
| DELETE | /campaigns/:id/maps/:mid/markers/:mkid | Owner | DeleteMarkerAPI |

## Future (Phase 2)

- Layers / marker groups
- Nested maps (click region to zoom into sub-map)
- Fog of war / progressive reveal
- Entity search typeahead for marker linking (replace raw ID input)
