# Audit Plugin

## Purpose

Campaign-scoped audit logging for Chronicle. Records user actions (entity CRUD,
membership changes, campaign settings updates) and provides an activity feed
for campaign owners. Also exposes per-entity change history for detailed tracking.

## Tier

Plugin (Campaign-scoped -- owner-only activity page)

## Domain Concepts

- **AuditEntry:** A record of a single user action (action, actor, target entity, timestamp).
- **Activity Feed:** Paginated timeline of audit entries for a campaign, shown on `/campaigns/:id/activity`.
- **CampaignStats:** Aggregate statistics (entity count, word count, active editors, last edit time).
- **Fire-and-Forget Logging:** The `Log()` method is designed so callers can ignore errors -- audit
  failures should not block primary operations.

## Files

| File | Purpose |
|------|---------|
| model.go | AuditEntry, CampaignStats structs, action constants |
| repository.go | SQL queries for audit log CRUD and aggregation |
| service.go | Business logic, pagination, validation |
| handler.go | Activity page and entity history handlers |
| routes.go | Campaign-scoped routes with role-based access |
| activity.templ | Activity page with stats cards and timeline |

## Dependencies

- **Uses:** campaigns (CampaignContext for campaign scoping, RequireRole middleware), auth (RequireAuth middleware), middleware (Render helper)
- **Used by:** Other plugins call `AuditService.Log()` to record their actions

## Routes

| Method | Path | Handler | Description |
|--------|------|---------|-------------|
| GET | /campaigns/:id/activity | Activity | Campaign activity page (owner only) |
| GET | /campaigns/:id/entities/:eid/history | EntityHistory | Entity change history JSON |

## Current State

- [x] .ai.md created
- [x] Model defined with action constants
- [x] Repository implemented (Log, ListByCampaign, ListByEntity, GetCampaignStats)
- [x] Service implemented with pagination and validation
- [x] Handler implemented (Activity, EntityHistory)
- [x] Routes defined
- [x] Activity page template with stats and timeline
- [x] Integrated with main router
- [x] Other plugins wired to call AuditService.Log() (entities, campaigns, tags)
- [ ] Tests written
