package admin

import (
	"fmt"
	"github.com/keyxmakerx/chronicle/internal/plugins/campaigns"
	"github.com/keyxmakerx/chronicle/internal/templates/layouts"
)

// AdminCampaignsPage renders the campaign management page with all campaigns.
templ AdminCampaignsPage(allCampaigns []campaigns.Campaign, total, page, perPage int, csrfToken string) {
	@layouts.App("Campaigns - Admin") {
		<div class="max-w-4xl mx-auto">
			<div class="flex justify-between items-center mb-6">
				<h1 class="text-2xl font-bold text-gray-900">All Campaigns ({ fmt.Sprintf("%d", total) })</h1>
				<a href="/admin" class="text-sm text-gray-500 hover:text-gray-700 transition-colors">Back to Admin</a>
			</div>
			<div class="card p-0 overflow-hidden">
				<table class="w-full">
					<thead>
						<tr class="bg-gray-50 border-b border-gray-200">
							<th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
							<th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Slug</th>
							<th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Created</th>
							<th class="text-right px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
						</tr>
					</thead>
					<tbody class="divide-y divide-gray-100">
						for _, c := range allCampaigns {
							<tr class="hover:bg-gray-50 transition-colors">
								<td class="px-4 py-3">
									<a href={ templ.SafeURL(fmt.Sprintf("/campaigns/%s", c.ID)) } class="text-sm font-medium text-accent hover:text-accent-hover transition-colors">
										{ c.Name }
									</a>
								</td>
								<td class="px-4 py-3 text-sm text-gray-400">{ c.Slug }</td>
								<td class="px-4 py-3 text-sm text-gray-400">
									{ c.CreatedAt.Format("Jan 2, 2006") }
								</td>
								<td class="px-4 py-3 text-right">
									<div class="flex items-center justify-end gap-3">
										<!-- Join as... dropdown -->
										<div class="relative" x-data="{ open: false }">
											<button
												@click="open = !open"
												@click.outside="open = false"
												class="text-sm text-accent hover:text-accent-hover transition-colors"
											>
												Join as...
											</button>
											<div
												x-show="open"
												x-transition
												class="absolute right-0 mt-1 w-36 bg-white rounded-lg shadow-lg border border-gray-200 z-10 overflow-hidden"
											>
												<form hx-post={ fmt.Sprintf("/admin/campaigns/%s/join", c.ID) } hx-headers={ fmt.Sprintf(`{"X-CSRF-Token":"%s"}`, csrfToken) }>
													<input type="hidden" name="csrf_token" value={ csrfToken }/>
													<button type="submit" name="role" value="player" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Player</button>
													<button type="submit" name="role" value="scribe" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">Scribe</button>
													<button type="submit" name="role" value="owner" class="block w-full text-left px-4 py-2 text-sm text-amber-600 hover:bg-gray-50 transition-colors">Owner (transfers)</button>
												</form>
											</div>
										</div>
										<button
											hx-delete={ fmt.Sprintf("/admin/campaigns/%s/leave", c.ID) }
											hx-headers={ fmt.Sprintf(`{"X-CSRF-Token":"%s"}`, csrfToken) }
											class="text-sm text-gray-400 hover:text-gray-700 transition-colors"
										>
											Leave
										</button>
										<button
											hx-delete={ fmt.Sprintf("/admin/campaigns/%s", c.ID) }
											hx-confirm="Permanently delete this campaign and all its data?"
											hx-headers={ fmt.Sprintf(`{"X-CSRF-Token":"%s"}`, csrfToken) }
											class="text-sm text-red-600 hover:text-red-800 transition-colors"
										>
											Delete
										</button>
									</div>
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
			<!-- Pagination -->
			if total > perPage {
				<div class="flex justify-center items-center gap-4 mt-6">
					if page > 1 {
						<a
							href={ templ.SafeURL(fmt.Sprintf("/admin/campaigns?page=%d", page-1)) }
							class="btn-secondary text-sm"
						>
							Previous
						</a>
					} else {
						<span class="btn text-sm text-gray-300 cursor-not-allowed opacity-50">Previous</span>
					}
					<span class="text-sm text-gray-500">
						Page { fmt.Sprintf("%d", page) } of { fmt.Sprintf("%d", (total+perPage-1)/perPage) }
					</span>
					if page*perPage < total {
						<a
							href={ templ.SafeURL(fmt.Sprintf("/admin/campaigns?page=%d", page+1)) }
							class="btn-secondary text-sm"
						>
							Next
						</a>
					} else {
						<span class="btn text-sm text-gray-300 cursor-not-allowed opacity-50">Next</span>
					}
				</div>
			}
		</div>
	}
}
