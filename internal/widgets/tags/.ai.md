# Tags Widget

## Purpose

Campaign-scoped entity tagging system for Chronicle. Tags are colored labels that
can be attached to entities for categorization and filtering. Provides API endpoints
for CRUD operations on tags and entity-tag associations. The frontend tag picker
widget auto-mounts on entity profile pages.

## Tier

Widget (Reusable UI block with API endpoints)

## Domain Concepts

- **Tag:** A campaign-scoped label with name, slug, and hex color. Unique slug per campaign.
- **EntityTag:** Many-to-many join between entities and tags. Stored in entity_tags table.
- **SetEntityTags:** Idempotent replacement operation -- diff-based to minimize DB writes.
- **Batch Loading:** GetEntityTagsBatch avoids N+1 queries on entity list views.

## Files

| File | Purpose |
|------|---------|
| model.go | Tag, EntityTag structs, request DTOs |
| repository.go | SQL queries for tags and entity_tags tables |
| service.go | Validation, slug generation, diff-based tag assignment |
| handler.go | JSON API handlers for tag CRUD and entity associations |
| routes.go | Campaign-scoped routes with role-based access |

## Dependencies

- **Uses:** campaigns (CampaignContext, RequireRole middleware), auth (RequireAuth), apperror
- **Used by:** Entity pages display tags via the frontend widget

## Routes

| Method | Path | Handler | Description |
|--------|------|---------|-------------|
| GET | /campaigns/:id/tags | ListTags | All tags for a campaign |
| POST | /campaigns/:id/tags | CreateTag | Create new tag (Scribe+) |
| PUT | /campaigns/:id/tags/:tagId | UpdateTag | Update tag (Scribe+) |
| DELETE | /campaigns/:id/tags/:tagId | DeleteTag | Delete tag (Scribe+) |
| GET | /campaigns/:id/entities/:eid/tags | GetEntityTags | Tags for an entity |
| PUT | /campaigns/:id/entities/:eid/tags | SetEntityTags | Replace entity tags (Scribe+) |

## Current State

- [x] .ai.md created
- [x] Model defined
- [x] Repository implemented (CRUD + batch loading)
- [x] Service implemented (validation, slug generation, diff-based assignment)
- [x] Handler implemented (JSON API)
- [x] Routes defined
- [x] Integrated with main router
- [ ] Frontend tag picker widget (JS)
- [ ] Tags displayed on entity profile pages
- [ ] Tests written
