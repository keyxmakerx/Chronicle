# Editor Widget

## Purpose

The TipTap-based rich text editor widget. Mounts to a DOM element, loads content
from an API endpoint, provides WYSIWYG editing with @mentions and entity linking,
and saves content back via API. This is the primary content authoring tool in
Chronicle.

## Tier

Widget (always available)

## Domain Concepts

- **TipTap:** A headless, framework-agnostic rich text editor built on
  ProseMirror. We use the vanilla JS build (no React/Vue).
- **Entry Content:** Entity content stored as ProseMirror JSON. The editor
  loads and saves this format.
- **@Mention:** Typing `@` triggers an entity/reference search. Selecting a
  result inserts a linked mention node in the document.

## Files

| File | Purpose |
|------|---------|
| handler.go | API: save/load entry content |
| templates/mount.templ | Renders the data-widget div for auto-mounting |

### Frontend Files (in static/)

| File | Purpose |
|------|---------|
| static/js/widgets/editor.js | TipTap initialization, save/load, @mention integration, secret mark toolbar |
| static/js/widgets/editor_secret.js | TipTap secret mark extension (GM-only inline text via Underline.extend()) |
| static/vendor/tiptap-bundle.min.js | Vendored TipTap build |

## Dependencies

- **Uses:** entities plugin (content API), mentions widget (@mention search)
- **Used by:** Entity profile page, entity posts

## API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | /api/v1/campaigns/:cid/entities/:eid/entry | Load entry content (JSON) |
| PUT | /api/v1/campaigns/:cid/entities/:eid/entry | Save entry content |

## Widget Config (data-* attributes)

```html
<div data-widget="editor"
     data-endpoint="/api/v1/campaigns/abc/entities/42/entry"
     data-editable="true"
     data-autosave="30">
</div>
```

| Attribute | Type | Description |
|-----------|------|-------------|
| data-endpoint | URL | API URL for loading/saving content |
| data-editable | bool | Enable editing (false = read-only render) |
| data-autosave | int | Autosave interval in seconds (0 = manual) |

## Current State

- [x] .ai.md created
- [x] TipTap vendored (static/vendor/tiptap-bundle.min.js)
- [x] editor.js widget created with Chronicle.register()
- [x] boot.js auto-mounter for all widgets
- [x] Handler for save/load (entities plugin: GetEntry, UpdateEntryAPI)
- [x] @mention integration (search popup, keyboard nav, styled entity links)
- [x] Autosave (configurable interval via data-autosave attribute)
- [x] View/edit mode toggle (read-only default, Edit/Done button, header bar)
- [x] enterEditMode() shows toolbar, enables editing, starts autosave
- [x] exitEditMode() saves content and returns to read-only view
- [x] Insert menu (+ dropdown: mention, link, hr, blockquote, code block)
- [x] Inline secrets mark (GM-only text, Ctrl+Shift+S, eye-slash toolbar button)
- [ ] Tests written

## Notes

- Content is stored as ProseMirror JSON in the `entry` column and pre-rendered
  HTML in `entry_html` for fast display.
- HTML output is sanitized with bluemonday before storage.
- The editor works in both "create new" (empty) and "edit existing" modes.
- View mode is the default -- users click "Edit" to enter editing mode. This
  prevents accidental edits and provides a cleaner reading experience.
- **Inline Secrets:** `editor_secret.js` defines a TipTap `secret` mark via
  `TipTap.Underline.extend()` (since the bundle doesn't export the raw Mark class).
  Renders as `<span data-secret="true" class="chronicle-secret">`. Server-side
  stripping in `internal/sanitize/` removes secrets from non-scribe users in both
  ProseMirror JSON and rendered HTML.
