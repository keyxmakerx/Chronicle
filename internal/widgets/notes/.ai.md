# Notes Widget

## Purpose
Floating personal note-taking panel (Google Keep-style) that appears in the
bottom-right corner of campaign pages. Each user has their own private notes
within a campaign, optionally scoped to specific entities (pages). Notes can
be shared with all campaign members via the `is_shared` flag.

## Architecture
- **Tier:** Widget (with full backend)
- **Addon slug:** `notes` (disabled by default, owner enables per-campaign)
- **Backend:** handler → service → repository → MariaDB `notes` + `note_versions` tables
- **Frontend:** `static/js/widgets/notes.js` — self-contained floating panel

## Data Model

### notes table (migration 000017 + 000022)
- Per-user, per-campaign, optional `entity_id` scoping
- Content is a JSON array of blocks: `[{type: "text", value: "..."}, {type: "checklist", items: [...]}]`
- Rich text: `entry` (ProseMirror JSON) + `entry_html` (pre-rendered HTML) dual storage
- Collaboration: `is_shared`, `last_edited_by`, `locked_by`, `locked_at`
- Pinned notes sort first, then by `updated_at` DESC

### note_versions table (migration 000022)
- Snapshot of note content at a point in time (title, content, entry, entry_html)
- FK cascade delete from `notes.id`
- Max 50 versions per note, oldest auto-pruned

## Key Features

### Core
- **Page-specific notes:** When viewing an entity, shows notes for that page
- **Campaign-wide notes:** General notes not tied to any entity
- **Checklists:** Interactive checkboxes with toggle API
- **Collapsible panel:** Minimizes to a small FAB, expands on click
- **Color coding:** Notes can have a color accent
- **Text size:** S/M/L settings gear (localStorage persistence)
- **Resizable panel:** Drag top-left corner to resize (localStorage persistence)

### Shared Notes (Sprint 4)
- **Share toggle:** Owner can make a note visible to all campaign members
- **Shared badge:** Non-owners see a users icon on shared notes
- **Access control:** Owner can edit all fields; non-owners can edit content only
  (cannot change pinned/shared status)
- **Delete:** Only the note owner can delete

### Pessimistic Edit Locking (Sprint 4)
- **Lock acquisition:** When editing a shared note, the widget POSTs to `/lock`
  before entering edit mode. If another user holds the lock, edit is denied.
- **Heartbeat:** 2-minute interval keeps the lock alive (server timeout is 5 min)
- **Lock release:** On "Done" click or panel close, the lock is released
- **Stale lock reclamation:** Locks older than 5 minutes are automatically
  reclaimed by the database query
- **Force unlock:** Campaign owners can force-unlock via `/force-unlock` endpoint
- **Lock indicator:** Locked-by-another notes show a lock icon, edit button hidden

### Version History (Sprint 4)
- **Snapshot-on-save:** Every `Update` and `RestoreVersion` saves the current
  state as a version before applying changes
- **Version list:** Sub-panel shows version history with title and timestamp
- **One-click restore:** Restoring a version creates a pre-restore snapshot,
  then applies the old version's content
- **Auto-pruning:** Oldest versions beyond `MaxVersionsPerNote` (50) are deleted

### Rich Text (Sprint 4)
- **Dual storage:** `entry` stores ProseMirror JSON, `entry_html` stores
  pre-rendered HTML (sanitized server-side)
- **Display:** When `entryHtml` is present on a note (view mode), it's rendered
  as HTML; legacy block content is used as fallback
- **Editing:** Rich text editing uses legacy blocks for now; full TipTap
  integration in the notes panel is a future enhancement

## Routes
All under `/campaigns/:id/notes`:

| Method | Path | Handler | Description |
|--------|------|---------|-------------|
| GET | `/` | List | List notes (scope=all\|campaign\|entity) |
| POST | `/` | Create | Create note |
| PUT | `/:noteId` | Update | Update note (creates version snapshot) |
| DELETE | `/:noteId` | Delete | Delete note (owner only) |
| POST | `/:noteId/toggle` | ToggleCheck | Toggle checklist item |
| POST | `/:noteId/lock` | Lock | Acquire edit lock |
| POST | `/:noteId/unlock` | Unlock | Release edit lock |
| POST | `/:noteId/heartbeat` | Heartbeat | Keep lock alive |
| POST | `/:noteId/force-unlock` | ForceUnlock | Force release (owner only) |
| GET | `/:noteId/versions` | ListVersions | Version history |
| GET | `/:noteId/versions/:vid` | GetVersion | Get specific version |
| POST | `/:noteId/versions/:vid/restore` | RestoreVersion | Restore to version |

## Frontend Widget
Registered as `Chronicle.register('notes', ...)`. Mounted via
`<div data-widget="notes" data-campaign-id="..." data-entity-id="..." data-user-id="...">` in the
app layout. The widget renders a fixed-position panel in the bottom-right.

### State
- `open`, `tab`, `notes`, `pageNotes`, `editingId`, `loading` (core)
- `lockedNoteId`, `lockHeartbeatTimer` (locking)
- `versionsNoteId`, `versions`, `versionsLoading` (version history)

### CSS Classes (in input.css)
- `.note-shared` — left accent border on shared notes
- `.note-shared-badge` — users icon badge
- `.note-lock-badge` — lock icon badge
- `.notes-lock-toast` — error toast animation
- `.note-entry-html` — rich text display container
- `.notes-versions-*` — version history sub-panel

## Dependencies
- **Uses:** `internal/apperror`, `internal/plugins/auth` (GetUserID, RequireAuth),
  `internal/plugins/campaigns` (RequireCampaignAccess, RequireRole, GetCampaignContext)
- **Used by:** App layout (`NotesWidget()` templ component)

## File Map
| File | Purpose |
|------|---------|
| model.go | Note, NoteVersion, Block, ChecklistItem structs; request DTOs; IsLocked()/IsLockedByUser() methods |
| repository.go | NoteRepository interface + MariaDB impl (CRUD, list queries, lock ops, version ops) |
| service.go | NoteService interface + impl (business logic, version snapshots, lock management) |
| handler.go | HTTP handlers (thin: bind, call service, render); canAccessNote helper |
| routes.go | Route registration on Echo campaign group |
| service_test.go | 28 unit tests with mock repository |
| .ai.md | This file |

## Testing
- 28 service tests covering: Create (8), Update (6), Delete (2), ToggleCheck (6),
  List queries (3), ID generation (2), and edge cases
- Mock repository with function fields for all 15 interface methods
