# Relations Widget

## Purpose

Bi-directional entity relation linking system for Chronicle. Relations are
directed links between two entities within a campaign (e.g., "allied with",
"parent of"/"child of"). When a relation is created A->B, the reverse B->A
is created automatically. Provides API endpoints for CRUD operations and a
frontend widget mounted on entity profile pages.

## Tier

Widget (Reusable UI block with API endpoints)

## Domain Concepts

- **Relation:** A directional link from source entity to target entity with a
  typed label. Stored in entity_relations table. Always exists in pairs (forward
  and reverse) for bi-directional consistency.
- **Relation Type:** A string label describing the nature of the link (e.g.,
  "allied with", "parent of"). Symmetric relations use the same type in both
  directions. Asymmetric relations have distinct forward and reverse types.
- **Common Types:** Predefined relation type pairs for the frontend suggestion
  list. Includes both symmetric (allied with) and asymmetric (parent of/child of)
  types.
- **Bi-directional Delete:** Deleting one direction automatically deletes the
  reverse to maintain graph consistency.

## Files

| File | Purpose |
|------|---------|
| model.go | Relation struct, request DTOs, common relation types |
| repository.go | SQL queries for entity_relations table |
| service.go | Validation, bi-directional create/delete logic |
| handler.go | JSON API handlers for relation CRUD |
| routes.go | Campaign-scoped routes with role-based access |

## Frontend

| File | Purpose |
|------|---------|
| static/js/widgets/relations.js | Relations display/management widget |

## Dependencies

- **Uses:** campaigns (CampaignContext, RequireRole middleware), auth (RequireAuth, GetUserID), apperror
- **Used by:** Entity profile pages display relations via the frontend widget

## Routes

| Method | Path | Handler | Description |
|--------|------|---------|-------------|
| GET | /campaigns/:id/entities/:eid/relations | ListRelations | Relations for an entity |
| POST | /campaigns/:id/entities/:eid/relations | CreateRelation | Create bi-directional relation (Scribe+) |
| DELETE | /campaigns/:id/entities/:eid/relations/:rid | DeleteRelation | Delete relation and reverse (Scribe+) |
| GET | /campaigns/:id/relation-types | GetCommonTypes | Predefined relation type pairs |

## Database

Table: `entity_relations` (migration 000012)

| Column | Type | Notes |
|--------|------|-------|
| id | INT AUTO_INCREMENT PK | |
| campaign_id | VARCHAR(36) | FK -> campaigns(id) CASCADE |
| source_entity_id | VARCHAR(36) | FK -> entities(id) CASCADE |
| target_entity_id | VARCHAR(36) | FK -> entities(id) CASCADE |
| relation_type | VARCHAR(100) | Forward label |
| reverse_relation_type | VARCHAR(100) | Reverse label |
| created_at | TIMESTAMP | |
| created_by | VARCHAR(36) | FK -> users(id) |

Unique: (source_entity_id, target_entity_id, relation_type)

## Current State

- [x] .ai.md created
- [x] Model defined
- [x] Repository implemented (CRUD + reverse lookup)
- [x] Service implemented (validation, bi-directional create/delete)
- [x] Handler implemented (JSON API)
- [x] Routes defined
- [x] Integrated with main router
- [x] Frontend relations widget (JS)
- [x] Relations block on entity profile pages
- [x] Relations block in template editor palette
- [ ] Tests written
